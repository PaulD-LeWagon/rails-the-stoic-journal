<div id="<%= dom_id task %>"
  class="card task<%= task.completed ? " card-checked" : "" %>"
  data-controller="cards task-buttons"
  data-cards-target="card"
  data-cards-url-value="<%= task_url task %>">

  <div class="card-header d-flex justify-content-between align-items-center">

    <h3 class="card-title">

      <i class="fa-solid fa-grip"></i>

      <span class="checkbox-wrapper">

        <label data-action="click->cards#onChecked"
          data-cards-target="cardFauxCheck"
          for="<%= "#{dom_id task}_completed" %>">

          <i class="<%= task.completed ? "" : "d-none " %>fa-solid fa-square-check"></i>
          <i class="<%= task.completed ? "d-none " : "" %>fa-solid fa-square"></i>

        </label>

        <input id="<%= "#{dom_id task}_completed" %>"
          class="checkbox d-none"
          data-cards-target="cardCompleted"
          type="checkbox"<%= task.completed ? " checked" : "" %>>

      </span>

      <span id="<%= "#{dom_id task}_order" %>"
        class="order-wrapper"
        data-cards-target="cardOrder"
        data-action="change->cards#onReorder">

        <%= task.order %>

      </span>

      <%= task.title %>
    </h3>

    <h3 class="start-date-time">

      <%#= task.start_date.strftime("%H:%M %C-%m-%Y") %>

    </h3>

    <div class="card-controls d-flex justify-content-end">

      <%= link_to(new_task_subtask_path(task),
        data: {
          turbo_frame: "new_subtask_for_#{ dom_id task }",
          task_buttons_target: "addSubtaskBtn",
          action: "click->task-buttons#addSubtaskClick"
        },
        class: "add-new-subtask btn btn-secondary m-1",
        title: "Add a subtask?"
      ) do %>

        <i class="fa-solid fa-square-plus"></i>

      <% end %>

      <% if policy(task).edit? %>

        <%= link_to(edit_task_path(task),
          data: {
            turbo_frame: "edit_#{ dom_id task }"
          },
          class: "btn btn-quarternary m-1",
          title: "Edit this task"
        ) do %>

          <i class="fa-solid fa-pen-to-square"></i>

        <% end %>

      <% end %>

      <a href="#" type="button"
        class="collapser btn btn-success m-1"
        title="View description"
        data-bs-toggle="collapse"
        data-bs-target="#<%= dom_id task %>_description"
        aria-expanded="false"
        aria-controls="<%= dom_id task %>_description">

        <i class="fa-solid fa-chevron-down"></i>

      </a>

      <button type="button"
        class="collapser btn btn-warning m-1"
        title="View all subtasks"
        data-bs-toggle="collapse"
        data-bs-target="#<%= dom_id task %>_subtasks"
        data-task-buttons-target="viewSubtasksBtn"
        aria-expanded="false"
        aria-controls="<%= dom_id task %>_subtasks">

        <%# = task.subtasks.empty? ? " disabled" : "" %>

        <i class="fa-solid fa-angles-down"></i>

      </button>

      <% if policy(task).destroy? %>

        <%= link_to(task_path(task),
          data: {
            turbo_method: :delete,
            turbo_confirm: "Are you sure?",
            action: "click->dragula#onDeleteTask"
          },
          class: "btn btn-danger m-1",
          title: "Delete this task?"
        ) do %>

          <i class="fa-solid fa-trash"></i>

        <% end %>

      <% end %>

    </div>

  </div>
  <div id="<%= dom_id task %>_description"
    class="card-body collapse"
    data-task-buttons-target="desc">

    <p class="card-text">
      <%= task.description %>
    </p>

  </div>

  <div id="<%= dom_id task %>_subtasks"
    class="cards subtasks-container collapse-container collapse"
    data-task-buttons-target="subtasks"
    data-subtasks-count="<%= task.subtasks.length %>">

    <%= turbo_frame_tag "new_subtask_for_#{ dom_id task }",
      data: {
        controller: "dragula",
        action: "turbo:frame-render->dragula#updateOrdinals"
      } do %>

      <% if task.subtasks.length.positive? %>

        <% task.subtasks.each do |subtask| %>

          <%= turbo_frame_tag "edit_#{ dom_id subtask }_for_#{ dom_id subtask.task }" do %>

            <%= render 'tasks/subtask_card', subtask: subtask %>

          <% end %>

        <% end %>

      <% end %>

    <% end %>

  </div>

</div>
